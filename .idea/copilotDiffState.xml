<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/tenant-service/src/test/java/org/example/tenantservice/repository/TenantRepositoryDataJpaTest.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/tenant-service/src/test/java/org/example/tenantservice/repository/TenantRepositoryDataJpaTest.java" />
              <option name="updatedContent" value="// ...existing code...&#10;package org.example.tenantservice.repository;&#10;&#10;import org.example.tenantservice.model.Tenant;&#10;import org.example.tenantservice.common.enums.Plan;&#10;import org.junit.jupiter.api.DisplayName;&#10;import org.junit.jupiter.api.Test;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;&#10;&#10;import java.util.Optional;&#10;&#10;import static org.assertj.core.api.Assertions.assertThat;&#10;&#10;@DataJpaTest&#10;class TenantRepositoryDataJpaTest {&#10;&#10;    @Autowired&#10;    TenantRepository tenantRepository;&#10;&#10;    @Test&#10;    @DisplayName(&quot;save and findByEmail should work&quot;)&#10;    void saveAndFindByEmail() {&#10;        Tenant t = Tenant.builder()&#10;                .email(&quot;repo-test@example.com&quot;)&#10;                .name(&quot;Repo Test&quot;)&#10;                .password(&quot;pwd&quot;)&#10;                .plan(Plan.FREE)&#10;                .build();&#10;&#10;        Tenant saved = tenantRepository.save(t);&#10;        assertThat(saved.getId()).isNotNull();&#10;&#10;        Optional&lt;Tenant&gt; found = tenantRepository.findByEmail(&quot;repo-test@example.com&quot;);&#10;        assertThat(found).isPresent();&#10;        assertThat(found.get().getEmail()).isEqualTo(&quot;repo-test@example.com&quot;);&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/tenant-service/src/test/java/org/example/tenantservice/web/AuthControllerWebMvcTest.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/tenant-service/src/test/java/org/example/tenantservice/web/AuthControllerWebMvcTest.java" />
              <option name="originalContent" value="&#10;&#10;&#10;&#10;&#10;&#10;&#10;" />
              <option name="updatedContent" value="package org.example.tenantservice.web;&#10;&#10;import com.fasterxml.jackson.databind.ObjectMapper;&#10;import org.example.tenantservice.controller.AuthController;&#10;import org.example.tenantservice.config.security.JwtAuthFilter;&#10;import org.example.tenantservice.config.security.JwtUtils;&#10;import org.example.tenantservice.config.security.UserDetailsServiceImpl;&#10;import org.example.tenantservice.dto.request.LoginRequest;&#10;import org.example.tenantservice.dto.request.TenantCreateRequest;&#10;import org.example.tenantservice.model.Tenant;&#10;import org.example.tenantservice.service.AuthService;&#10;import org.junit.jupiter.api.DisplayName;&#10;import org.junit.jupiter.api.Test;&#10;import org.junit.jupiter.api.extension.ExtendWith;&#10;import org.mockito.Mockito;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration;&#10;import org.springframework.boot.autoconfigure.security.servlet.SecurityFilterAutoConfiguration;&#10;import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;&#10;import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;&#10;import org.springframework.boot.test.mock.mockito.MockBean;&#10;import org.springframework.context.annotation.ComponentScan;&#10;import org.springframework.context.annotation.FilterType;&#10;import org.springframework.http.MediaType;&#10;import org.springframework.test.context.junit.jupiter.SpringExtension;&#10;import org.springframework.test.web.servlet.MockMvc;&#10;&#10;import static org.hamcrest.Matchers.is;&#10;import static org.mockito.ArgumentMatchers.any;&#10;import static org.mockito.ArgumentMatchers.eq;&#10;import static org.mockito.Mockito.when;&#10;import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;&#10;import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;&#10;import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.jsonPath;&#10;import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;&#10;&#10;@ExtendWith(SpringExtension.class)&#10;@WebMvcTest(controllers = AuthController.class,&#10;        excludeAutoConfiguration = {SecurityAutoConfiguration.class, SecurityFilterAutoConfiguration.class},&#10;        excludeFilters = @ComponentScan.Filter(type = FilterType.ASSIGNABLE_TYPE, classes = JwtAuthFilter.class))&#10;@AutoConfigureMockMvc(addFilters = false)&#10;class AuthControllerWebMvcTest {&#10;&#10;    @Autowired&#10;    MockMvc mockMvc;&#10;&#10;    @Autowired&#10;    ObjectMapper objectMapper;&#10;&#10;    @MockBean&#10;    AuthService authService;&#10;&#10;    // mock security-related beans so JwtAuthFilter and other security components don't block context startup&#10;    @MockBean&#10;    JwtUtils jwtUtils;&#10;&#10;    @MockBean&#10;    UserDetailsServiceImpl userDetailsService;&#10;&#10;    @MockBean&#10;    JwtAuthFilter jwtAuthFilter;&#10;&#10;    @Test&#10;    @DisplayName(&quot;POST /auth/register - returns 201 and tenant payload&quot;)&#10;    void registerUser_returnsCreated() throws Exception {&#10;        TenantCreateRequest req = new TenantCreateRequest();&#10;        req.setEmail(&quot;new@example.com&quot;);&#10;        req.setName(&quot;New&quot;);&#10;        req.setPassword(&quot;secret&quot;);&#10;&#10;        Tenant saved = Tenant.builder()&#10;                .id(&quot;t-1&quot;)&#10;                .email(req.getEmail())&#10;                .name(req.getName())&#10;                .build();&#10;&#10;        when(authService.registerNewTenant(any())).thenReturn(saved);&#10;&#10;        mockMvc.perform(post(&quot;/auth/register&quot;)&#10;                        .contentType(MediaType.APPLICATION_JSON)&#10;                        .content(objectMapper.writeValueAsString(req)))&#10;                .andExpect(status().isCreated())&#10;                .andExpect(jsonPath(&quot;$.data.email&quot;, is(saved.getEmail())))&#10;                .andExpect(jsonPath(&quot;$.data.id&quot;, is(saved.getId())));&#10;    }&#10;&#10;    @Test&#10;    @DisplayName(&quot;POST /auth/login - returns 200 and jwt token&quot;)&#10;    void login_returnsToken() throws Exception {&#10;        LoginRequest req = new LoginRequest();&#10;        req.setEmail(&quot;a@b.com&quot;);&#10;        req.setPassword(&quot;pass&quot;);&#10;&#10;        when(authService.loginUser(eq(req.getEmail()), eq(req.getPassword()))).thenReturn(&quot;jwt-token&quot;);&#10;&#10;        mockMvc.perform(post(&quot;/auth/login&quot;)&#10;                        .contentType(MediaType.APPLICATION_JSON)&#10;                        .content(objectMapper.writeValueAsString(req)))&#10;                .andExpect(status().isOk())&#10;                .andExpect(jsonPath(&quot;$.data.token&quot;, is(&quot;jwt-token&quot;)));&#10;    }&#10;&#10;    @Test&#10;    @DisplayName(&quot;GET /auth/internal/apikeys/validate - returns permissions set&quot;)&#10;    void validateApiKey_returnsPermissions() throws Exception {&#10;        when(authService.validateApiKeyAndGetPermissions(&quot;raw-key&quot;)).thenReturn(java.util.Set.of(&quot;READ&quot;));&#10;&#10;        mockMvc.perform(get(&quot;/auth/internal/apikeys/validate&quot;)&#10;                        .header(&quot;X-API-Key-To-Validate&quot;, &quot;raw-key&quot;))&#10;                .andExpect(status().isOk())&#10;                .andExpect(jsonPath(&quot;[0]&quot;, is(&quot;READ&quot;)));&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>